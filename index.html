<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Gaze Project - 400 Seconds</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    <style>
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden; background-color: black;
            font-family: 'Pretendard', sans-serif;
        }

        /* 3D 캔버스가 들어갈 컨테이너 */
        #canvas-parent {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }

        #status-msg {
            display: none; color: white; font-size: 5vw; font-weight: bold;
            text-align: center; width: 80%; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            pointer-events: none; /* 마우스 방해 금지 */
        }

        #svgPathContainer {
            position: absolute; top: 0; left: 0;
            width: 100vw; height: 100vh;
            display: none; background-color: white; z-index: 100;
        }

        #ui-overlay {
            display: none; position: absolute; bottom: 8%;
            left: 50%; transform: translateX(-50%);
            text-align: center; z-index: 110;
        }

        .credits { margin-bottom: 20px; color: black; font-size: 14px; line-height: 1.6; }
        #download-btn { padding: 12px 24px; background: black; color: white; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="canvas-parent"></div>
<div id="status-msg">Waiting for <span id="out-timer">0</span> seconds</div>

<div id="svgPathContainer">
    <svg id="pathSvg" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
        <polyline id="pathPolyline" fill="none" stroke="black" stroke-width="2" />
    </svg>
</div>

<div id="ui-overlay">
    <div class="credits">
        You waited 400 seconds.<br>
        Concept & Production: <a href="https://www.instagram.com/wegee.eui/" target="_blank" style="color:black;">Wegee @wegee.eui</a>
    </div>
    <button id="download-btn">이미지 저장하기</button>
</div>

<script>
    const TARGET_SECONDS = 400; 
    const MSG_DELAY_MS = 200; 

    let eyeModel;
    let totalOutTimeMs = 0;
    let outStartTime = null;
    let stayStartTime;
    let path = [];
    let isFinished = false;
    let msgTimeout = null;

    function setup() {
        // 캔버스를 생성하고 #canvas-parent 안에 넣음
        let cnv = createCanvas(windowWidth, windowHeight, WEBGL);
        cnv.parent('canvas-parent');
        angleMode(DEGREES);
        buildEye();
        stayStartTime = millis();
    }

    function buildEye() {
        if (eyeModel) freeGeometry(eyeModel);
        eyeModel = buildGeometry(() => {
            // 흰자 (Sclera) - 요청하신 40/60 비율 비대칭 느낌 적용
            push();
            fill(255);
            noStroke();
            rotateZ(5); // 눈매의 기울기
            ellipsoid(120, 85, 40); 
            pop();

            // 눈동자 (Pupil) - 40% 크기 비율
            push();
            fill(0);
            translate(0, 0, 32); 
            scale(1, 1, 0.4);
            sphere(45); 
            pop();
        });
        eyeModel.normalize();
    }

    function draw() {
        if (isFinished) return;
        background(0);

        // 시선/존재 동기화 체크
        checkFocus();

        // 3D 조명 및 재질
        ambientLight(100);
        pointLight(255, 255, 255, 200, -200, 300);
        specularMaterial(255);
        shininess(100);

        // 마우스 경로 기록
        if (focused) path.push({ x: mouseX, y: mouseY });

        // 양쪽 눈 그리기 (가로 80% 비율 배치)
        let eyeSpacing = width * 0.4; 
        
        for (let mirror of [-1, 1]) {
            push();
            translate(mirror * (eyeSpacing / 2), 0, 0);
            
            // 오른쪽 눈은 가로 대칭 (scaleX -1 효과)
            if (mirror === 1) scale(-1, 1, 1);

            // 마우스 바라보기 (눈동자 움직임 구현)
            let rotY = map(mouseX - width/2, -width/2, width/2, -25, 25);
            let rotX = map(mouseY - height/2, -height/2, height/2, 20, -20);
            rotateY(rotY * mirror); 
            rotateX(rotX);

            model(eyeModel);
            pop();
        }

        // 목표 달성 체크
        if (millis() - stayStartTime - totalOutTimeMs >= TARGET_SECONDS * 1000) {
            finish();
        }
    }

    function checkFocus() {
        if (!focused) {
            if (!outStartTime) outStartTime = millis();
            if (!msgTimeout) {
                msgTimeout = setTimeout(() => {
                    document.getElementById('status-msg').style.display = 'block';
                }, MSG_DELAY_MS);
            }
        } else {
            if (outStartTime) {
                totalOutTimeMs += millis() - outStartTime;
                outStartTime = null;
            }
            if (msgTimeout) {
                clearTimeout(msgTimeout);
                msgTimeout = null;
            }
            document.getElementById('status-msg').style.display = 'none';
        }
        
        let currentOut = totalOutTimeMs + (outStartTime ? (millis() - outStartTime) : 0);
        document.getElementById('out-timer').textContent = Math.floor(currentOut / 1000);
    }

    function finish() {
        isFinished = true;
        noLoop(); // p5.js 루프 정지
        document.getElementById('canvas-parent').style.display = 'none';
        document.getElementById('svgPathContainer').style.display = 'block';
        document.getElementById('ui-overlay').style.display = 'block';

        const poly = document.getElementById('pathPolyline');
        const svg = document.getElementById('pathSvg');
        
        const xs = path.map(p => p.x);
        const ys = path.map(p => p.y);
        const minX = Math.min(...xs) - 50;
        const minY = Math.min(...ys) - 50;
        const w = Math.max(...xs) - minX + 50;
        const h = Math.max(...ys) - minY + 50;

        svg.setAttribute('viewBox', `${minX} ${minY} ${w} ${h}`);
        poly.setAttribute('points', path.map(p => `${p.x},${p.y}`).join(' '));
    }

    function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
    }

    // 다운로드 로직은 기존과 동일
    document.getElementById('download-btn').addEventListener('click', () => {
        const svg = document.getElementById('pathSvg');
        const svgData = new XMLSerializer().serializeToString(svg);
        const canvas = document.createElement('canvas');
        const viewBox = svg.viewBox.baseVal;
        canvas.width = viewBox.width * 3;
        canvas.height = viewBox.height * 3;
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.onload = () => {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const link = document.createElement('a');
            link.download = 'gaze-path.png';
            link.href = canvas.toDataURL();
            link.click();
        };
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
    });
</script>

</body>
</html>
