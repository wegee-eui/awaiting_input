<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>400 Seconds of Gaze</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: black;
            font-family: 'Pretendard', 'Nanum Gothic', sans-serif;
            transition: background-color 0.5s;
        }

        #container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* 눈 컨테이너: 가로 80% */
        .eyes-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 80%;
            max-width: 1200px;
        }

        .eye {
            background-color: white;
            width: 45%;
            aspect-ratio: 2 / 1;
            border-radius: 50% 50%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .pupil {
            background-color: black;
            width: 30%;
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            position: absolute;
        }

        /* 상태 메시지 */
        #status-msg {
            display: none;
            color: white;
            font-size: 5vw;
            font-weight: bold;
            text-align: center;
            width: 80%;
        }

        /* 결과 캔버스 */
        #pathCanvas {
            position: absolute;
            top: 0;
            left: 0;
            display: none;
            background-color: white;
        }

        /* 종료 UI */
        #ui-overlay {
            display: none;
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 10;
        }

        .credits {
            margin-bottom: 20px;
            line-height: 1.6;
            color: black;
        }

        .credits a {
            color: black;
            text-decoration: underline;
        }

        #download-btn {
            padding: 12px 24px;
            background: black;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
    </style>
</head>
<body>

<div id="container">
    <div class="eyes-wrapper" id="eyes-container">
        <div class="eye"><div class="pupil"></div></div>
        <div class="eye"><div class="pupil"></div></div>
    </div>
    <div id="status-msg">Waiting for <span id="timer">15</span> seconds</div>
    <canvas id="pathCanvas"></canvas>
</div>

<div id="ui-overlay">
    <div class="credits">
        You waited 400 seconds.<br>
        Concept & Production: <a href="https://www.instagram.com/wegee.eui/" target="_blank">Wegee @wegee.eui</a>
    </div>
    <button id="download-btn">Save Gaze Path</button>
</div>

<script>
    const eyesContainer = document.getElementById('eyes-container');
    const pupils = document.querySelectorAll('.pupil');
    const statusMsg = document.getElementById('status-msg');
    const timerSpan = document.getElementById('timer');
    const canvas = document.getElementById('pathCanvas');
    const ctx = canvas.getContext('2d');
    const uiOverlay = document.getElementById('ui-overlay');
    const downloadBtn = document.getElementById('download-btn');

    let startTime = Date.now();
    let timeLeft = 15;
    let path = [];
    let isFinished = false;
    let isTabActive = true;

    // 캔버스 사이즈 설정
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // 마우스 움직임 기록 및 눈동자 제어
    window.addEventListener('mousemove', (e) => {
        if (isFinished) return;

        // 마우스 경로 기록
        path.push({ x: e.clientX, y: e.clientY, time: Date.now() });

        // 눈동자 움직임
        pupils.forEach(pupil => {
            const rect = pupil.parentElement.getBoundingClientRect();
            const eyeX = rect.left + rect.width / 2;
            const eyeY = rect.top + rect.height / 2;
            
            const angle = Math.atan2(e.clientY - eyeY, e.clientX - eyeX);
            const distance = Math.min(rect.width / 4, Math.hypot(e.clientX - eyeX, e.clientY - eyeY) / 10);
            
            const moveX = Math.cos(angle) * distance;
            const moveY = Math.sin(angle) * distance;
            
            pupil.style.transform = `translate(${moveX}px, ${moveY}px)`;
        });
    });

    // 시선/존재 동기화 감지 (Focus/Blur 및 Mouse Leave)
    function setWaiting(isWaiting) {
        if (isFinished) return;
        if (isWaiting) {
            eyesContainer.style.display = 'none';
            statusMsg.style.display = 'block';
        } else {
            eyesContainer.style.display = 'flex';
            statusMsg.style.display = 'none';
        }
    }

    window.addEventListener('blur', () => { isTabActive = false; setWaiting(true); });
    window.addEventListener('focus', () => { isTabActive = true; setWaiting(false); });
    document.addEventListener('mouseleave', () => setWaiting(true));
    document.addEventListener('mouseenter', () => setWaiting(false));

    // 타이머 로직
    const timerInterval = setInterval(() => {
        if (isTabActive && !isFinished) {
            timeLeft--;
            timerSpan.textContent = Math.max(0, timeLeft);

            if (timeLeft <= 0) {
                finishGame();
            }
        }
    }, 1000);

    // 400초 달성 시 종료 처리
    function finishGame() {
        isFinished = true;
        clearInterval(timerInterval);
        
        document.body.style.backgroundColor = 'white';
        eyesContainer.style.display = 'none';
        statusMsg.style.display = 'none';
        
        canvas.style.display = 'block';
        drawPath();
        uiOverlay.style.display = 'block';
    }

    // 마우스 경로 그리기
    function drawPath() {
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.beginPath();
        if (path.length > 0) {
            ctx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) {
                ctx.lineTo(path[i].x, path[i].y);
            }
        }
        ctx.stroke();
    }

    // 이미지 저장 기능
    downloadBtn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = 'my-gaze-path.png';
        link.href = canvas.toDataURL();
        link.click();
    });
</script>

</body>
</html>
